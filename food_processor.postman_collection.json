{
  "info": {
    "name": "Food Processor API",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json",
    "description": "Video-to-Ingredients extraction API. Submit a YouTube URL, poll for status, retrieve structured ingredient data. Supports Tier 0 (metadata), Tier 1 (transcript + LLM), and Tier 2 (Gemini 2.5 Flash video analysis).\n\nFeatures:\n- Recipe extraction from YouTube videos\n- Recipe card gallery with AI-generated images\n- AI-powered ingredient swap suggestions with dietary filtering\n\nDevice-based auth: register a device first to get an API key, then include X-API-Key on all extraction requests. Free users see max 5 ingredients; premium users see all."
  },
  "variable": [
    {
      "key": "base_url",
      "value": "http://localhost:3000"
    },
    {
      "key": "job_id",
      "value": ""
    },
    {
      "key": "api_key",
      "value": ""
    },
    {
      "key": "device_id",
      "value": "test-device-001"
    },
    {
      "key": "card_id",
      "value": ""
    }
  ],
  "item": [
    {
      "name": "Health Check",
      "request": {
        "method": "GET",
        "url": {
          "raw": "{{base_url}}/api/health",
          "host": ["{{base_url}}"],
          "path": ["api", "health"]
        }
      }
    },
    {
      "name": "Register Device",
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "const res = pm.response.json();",
              "pm.collectionVariables.set('api_key', res.api_key);",
              "pm.collectionVariables.set('device_id', res.device_id);",
              "pm.test('Returns 201', () => pm.response.to.have.status(201));",
              "pm.test('Has api_key', () => pm.expect(res.api_key).to.be.a('string'));",
              "pm.test('Has device_id', () => pm.expect(res.device_id).to.be.a('string'));",
              "pm.test('is_premium is false', () => pm.expect(res.is_premium).to.eql(false));"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "url": {
          "raw": "{{base_url}}/api/devices/register",
          "host": ["{{base_url}}"],
          "path": ["api", "devices", "register"]
        },
        "header": [
          { "key": "Content-Type", "value": "application/json" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"device_id\": \"{{device_id}}\"\n}"
        }
      }
    },
    {
      "name": "Register Device — Missing Body",
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Returns 400', () => pm.response.to.have.status(400));"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "url": {
          "raw": "{{base_url}}/api/devices/register",
          "host": ["{{base_url}}"],
          "path": ["api", "devices", "register"]
        },
        "header": [
          { "key": "Content-Type", "value": "application/json" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{}"
        }
      }
    },
    {
      "name": "Device Me",
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "const res = pm.response.json();",
              "pm.test('Returns 200', () => pm.response.to.have.status(200));",
              "pm.test('Has device_id', () => pm.expect(res.device_id).to.be.a('string'));",
              "pm.test('Has is_premium', () => pm.expect(res.is_premium).to.be.a('boolean'));"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "url": {
          "raw": "{{base_url}}/api/devices/me",
          "host": ["{{base_url}}"],
          "path": ["api", "devices", "me"]
        },
        "header": [
          { "key": "X-API-Key", "value": "{{api_key}}" }
        ]
      }
    },
    {
      "name": "Device Me — No API Key",
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Returns 401', () => pm.response.to.have.status(401));"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "url": {
          "raw": "{{base_url}}/api/devices/me",
          "host": ["{{base_url}}"],
          "path": ["api", "devices", "me"]
        }
      }
    },
    {
      "name": "Extract — Babish Aglio e Olio (Tier 0, recipe link)",
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "const res = pm.response.json();",
              "pm.collectionVariables.set('job_id', res.job_id);",
              "pm.test('Returns job_id', () => pm.expect(res.job_id).to.be.a('string'));",
              "pm.test('Status is queued', () => pm.expect(res.status).to.eql('queued'));"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "url": {
          "raw": "{{base_url}}/api/extract",
          "host": ["{{base_url}}"],
          "path": ["api", "extract"]
        },
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "X-API-Key", "value": "{{api_key}}" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"youtube_url\": \"https://www.youtube.com/watch?v=bJUiWdM__Qw\"\n}"
        }
      }
    },
    {
      "name": "Extract — Adam Ragusea Pizza Bread (Tier 0, description)",
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "const res = pm.response.json();",
              "pm.collectionVariables.set('job_id', res.job_id);",
              "pm.test('Returns job_id', () => pm.expect(res.job_id).to.be.a('string'));"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "url": {
          "raw": "{{base_url}}/api/extract",
          "host": ["{{base_url}}"],
          "path": ["api", "extract"]
        },
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "X-API-Key", "value": "{{api_key}}" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"youtube_url\": \"https://www.youtube.com/watch?v=o4ABOKdHEUs\"\n}"
        }
      }
    },
    {
      "name": "Extract — Babish Kitchen Tools (Tier 1, transcript only)",
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "const res = pm.response.json();",
              "pm.collectionVariables.set('job_id', res.job_id);",
              "pm.test('Returns job_id', () => pm.expect(res.job_id).to.be.a('string'));"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "url": {
          "raw": "{{base_url}}/api/extract",
          "host": ["{{base_url}}"],
          "path": ["api", "extract"]
        },
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "X-API-Key", "value": "{{api_key}}" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"youtube_url\": \"https://www.youtube.com/watch?v=1AxLzMJIgxM\"\n}"
        }
      }
    },
    {
      "name": "Extract — Penne Arrabbiata (Tier 2, video analysis)",
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "const res = pm.response.json();",
              "pm.collectionVariables.set('job_id', res.job_id);",
              "pm.test('Returns job_id', () => pm.expect(res.job_id).to.be.a('string'));",
              "pm.test('Status is queued', () => pm.expect(res.status).to.eql('queued'));"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "url": {
          "raw": "{{base_url}}/api/extract",
          "host": ["{{base_url}}"],
          "path": ["api", "extract"]
        },
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "X-API-Key", "value": "{{api_key}}" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"youtube_url\": \"https://www.youtube.com/watch?v=1IszT_guI08\"\n}"
        }
      }
    },
    {
      "name": "Extract — Invalid URL",
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Returns 400', () => pm.response.to.have.status(400));",
              "pm.test('Has error message', () => pm.expect(pm.response.json().error).to.be.a('string'));"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "url": {
          "raw": "{{base_url}}/api/extract",
          "host": ["{{base_url}}"],
          "path": ["api", "extract"]
        },
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "X-API-Key", "value": "{{api_key}}" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"youtube_url\": \"https://example.com/not-a-video\"\n}"
        }
      }
    },
    {
      "name": "Extract — Missing Body",
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Returns 400', () => pm.response.to.have.status(400));"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "url": {
          "raw": "{{base_url}}/api/extract",
          "host": ["{{base_url}}"],
          "path": ["api", "extract"]
        },
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "X-API-Key", "value": "{{api_key}}" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{}"
        }
      }
    },
    {
      "name": "Extract — No API Key (401)",
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Returns 401', () => pm.response.to.have.status(401));",
              "pm.test('Has error message', () => pm.expect(pm.response.json().error).to.be.a('string'));"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "url": {
          "raw": "{{base_url}}/api/extract",
          "host": ["{{base_url}}"],
          "path": ["api", "extract"]
        },
        "header": [
          { "key": "Content-Type", "value": "application/json" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"youtube_url\": \"https://www.youtube.com/watch?v=bJUiWdM__Qw\"\n}"
        }
      }
    },
    {
      "name": "Job Status",
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "const res = pm.response.json();",
              "pm.test('Has status field', () => pm.expect(res.status).to.be.a('string'));",
              "pm.test('Has progress field', () => pm.expect(res.progress).to.be.a('number'));"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "url": {
          "raw": "{{base_url}}/api/status/{{job_id}}",
          "host": ["{{base_url}}"],
          "path": ["api", "status", "{{job_id}}"]
        },
        "header": [
          { "key": "X-API-Key", "value": "{{api_key}}" }
        ]
      }
    },
    {
      "name": "Job Results",
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "if (pm.response.code === 200) {",
              "  const res = pm.response.json();",
              "  pm.test('Has video_id', () => pm.expect(res.video_id).to.be.a('string'));",
              "  pm.test('Has ingredients', () => pm.expect(res.ingredients).to.be.an('array'));",
              "  pm.test('Has shopping_list', () => pm.expect(res.shopping_list).to.be.an('object'));",
              "  pm.test('Has confidence', () => pm.expect(res.confidence).to.be.a('number'));",
              "  pm.test('Has processing_metadata', () => pm.expect(res.processing_metadata).to.be.an('object'));",
              "  pm.test('Has is_truncated', () => pm.expect(res.is_truncated).to.be.a('boolean'));",
              "  pm.test('Has total_ingredient_count', () => pm.expect(res.total_ingredient_count).to.be.a('number'));",
              "  pm.test('Has shown_ingredient_count', () => pm.expect(res.shown_ingredient_count).to.be.a('number'));",
              "  if (res.is_truncated) {",
              "    pm.test('Truncated: max 5 ingredients', () => pm.expect(res.ingredients.length).to.be.at.most(5));",
              "    pm.test('Truncated: has upgrade_message', () => pm.expect(res.upgrade_message).to.be.a('string'));",
              "  }",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "url": {
          "raw": "{{base_url}}/api/results/{{job_id}}",
          "host": ["{{base_url}}"],
          "path": ["api", "results", "{{job_id}}"]
        },
        "header": [
          { "key": "X-API-Key", "value": "{{api_key}}" }
        ]
      }
    },
    {
      "name": "Job Status — Not Found",
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Returns 404', () => pm.response.to.have.status(404));"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "url": {
          "raw": "{{base_url}}/api/status/nonexistent_job",
          "host": ["{{base_url}}"],
          "path": ["api", "status", "nonexistent_job"]
        },
        "header": [
          { "key": "X-API-Key", "value": "{{api_key}}" }
        ]
      }
    },
    {
      "name": "Gallery — Save Recipe Card",
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "const res = pm.response.json();",
              "pm.collectionVariables.set('card_id', res.card_id);",
              "pm.test('Returns 201', () => pm.response.to.have.status(201));",
              "pm.test('Has card_id', () => pm.expect(res.card_id).to.be.a('string'));",
              "pm.test('Has recipe_name', () => pm.expect(res.recipe_name).to.eql('Spaghetti Aglio e Olio'));",
              "pm.test('Has ingredients', () => pm.expect(res.ingredients).to.be.an('array'));",
              "pm.test('Has is_truncated', () => pm.expect(res.is_truncated).to.be.a('boolean'));",
              "pm.test('Has total_ingredient_count', () => pm.expect(res.total_ingredient_count).to.be.a('number'));",
              "pm.test('Has shown_ingredient_count', () => pm.expect(res.shown_ingredient_count).to.be.a('number'));",
              "if (res.is_truncated) {",
              "  pm.test('Truncated: max 5 ingredients', () => pm.expect(res.ingredients.length).to.be.at.most(5));",
              "  pm.test('Truncated: has upgrade_message', () => pm.expect(res.upgrade_message).to.be.a('string'));",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "url": {
          "raw": "{{base_url}}/api/gallery",
          "host": ["{{base_url}}"],
          "path": ["api", "gallery"]
        },
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "X-API-Key", "value": "{{api_key}}" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"recipe_name\": \"Spaghetti Aglio e Olio\",\n  \"video_id\": \"bJUiWdM__Qw\",\n  \"video_title\": \"Pasta Aglio e Olio\",\n  \"channel\": \"Binging with Babish\",\n  \"servings\": 2,\n  \"ingredients\": [\n    { \"name\": \"spaghetti\", \"canonical_name\": \"spaghetti\", \"quantity\": 400, \"unit\": \"g\", \"raw_text\": \"400g spaghetti\", \"category\": \"Pasta & Grains\", \"optional\": false, \"preparation\": null },\n    { \"name\": \"garlic\", \"canonical_name\": \"garlic\", \"quantity\": 6, \"unit\": \"cloves\", \"raw_text\": \"6 cloves garlic\", \"category\": \"Produce\", \"optional\": false, \"preparation\": \"thinly sliced\" },\n    { \"name\": \"extra virgin olive oil\", \"canonical_name\": \"olive oil\", \"quantity\": 0.5, \"unit\": \"cup\", \"raw_text\": \"1/2 cup extra virgin olive oil\", \"category\": \"Oils & Vinegars\", \"optional\": false, \"preparation\": null },\n    { \"name\": \"red pepper flakes\", \"canonical_name\": \"red pepper flakes\", \"quantity\": 1, \"unit\": \"tsp\", \"raw_text\": \"1 tsp red pepper flakes\", \"category\": \"Spices & Seasonings\", \"optional\": false, \"preparation\": null },\n    { \"name\": \"parsley\", \"canonical_name\": \"parsley\", \"quantity\": 0.25, \"unit\": \"cup\", \"raw_text\": \"1/4 cup fresh parsley\", \"category\": \"Produce\", \"optional\": false, \"preparation\": \"chopped\" },\n    { \"name\": \"parmesan cheese\", \"canonical_name\": \"parmesan\", \"quantity\": 0.5, \"unit\": \"cup\", \"raw_text\": \"1/2 cup parmesan\", \"category\": \"Dairy\", \"optional\": true, \"preparation\": \"grated\" },\n    { \"name\": \"salt\", \"canonical_name\": \"salt\", \"quantity\": null, \"unit\": null, \"raw_text\": \"salt to taste\", \"category\": \"Spices & Seasonings\", \"optional\": false, \"preparation\": null },\n    { \"name\": \"black pepper\", \"canonical_name\": \"black pepper\", \"quantity\": null, \"unit\": null, \"raw_text\": \"black pepper to taste\", \"category\": \"Spices & Seasonings\", \"optional\": false, \"preparation\": null }\n  ],\n  \"shopping_list\": {\n    \"Pasta & Grains\": [\"spaghetti\"],\n    \"Produce\": [\"garlic\", \"parsley\"],\n    \"Oils & Vinegars\": [\"olive oil\"],\n    \"Spices & Seasonings\": [\"red pepper flakes\", \"salt\", \"black pepper\"],\n    \"Dairy\": [\"parmesan\"]\n  },\n  \"generate_image\": false\n}"
        }
      }
    },
    {
      "name": "Gallery — Save Card (Missing recipe_name)",
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Returns 400', () => pm.response.to.have.status(400));",
              "pm.test('Has error', () => pm.expect(pm.response.json().error).to.be.a('string'));"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "url": {
          "raw": "{{base_url}}/api/gallery",
          "host": ["{{base_url}}"],
          "path": ["api", "gallery"]
        },
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "X-API-Key", "value": "{{api_key}}" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"ingredients\": []\n}"
        }
      }
    },
    {
      "name": "Gallery — List Cards",
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "const res = pm.response.json();",
              "pm.test('Returns 200', () => pm.response.to.have.status(200));",
              "pm.test('Has cards array', () => pm.expect(res.cards).to.be.an('array'));",
              "pm.test('Has limit', () => pm.expect(res.limit).to.be.a('number'));",
              "pm.test('Has offset', () => pm.expect(res.offset).to.be.a('number'));",
              "if (res.cards.length > 0) {",
              "  pm.test('Card has card_id', () => pm.expect(res.cards[0].card_id).to.be.a('string'));",
              "  pm.test('Card has recipe_name', () => pm.expect(res.cards[0].recipe_name).to.be.a('string'));",
              "  pm.test('Card has is_truncated', () => pm.expect(res.cards[0].is_truncated).to.be.a('boolean'));",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "url": {
          "raw": "{{base_url}}/api/gallery?limit=20&offset=0",
          "host": ["{{base_url}}"],
          "path": ["api", "gallery"],
          "query": [
            { "key": "limit", "value": "20" },
            { "key": "offset", "value": "0" }
          ]
        },
        "header": [
          { "key": "X-API-Key", "value": "{{api_key}}" }
        ]
      }
    },
    {
      "name": "Gallery — Get Card",
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "const res = pm.response.json();",
              "pm.test('Returns 200', () => pm.response.to.have.status(200));",
              "pm.test('Has card_id', () => pm.expect(res.card_id).to.be.a('string'));",
              "pm.test('Has recipe_name', () => pm.expect(res.recipe_name).to.be.a('string'));",
              "pm.test('Has ingredients', () => pm.expect(res.ingredients).to.be.an('array'));",
              "pm.test('Has is_truncated', () => pm.expect(res.is_truncated).to.be.a('boolean'));",
              "pm.test('Has total_ingredient_count', () => pm.expect(res.total_ingredient_count).to.be.a('number'));"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "url": {
          "raw": "{{base_url}}/api/gallery/{{card_id}}",
          "host": ["{{base_url}}"],
          "path": ["api", "gallery", "{{card_id}}"]
        },
        "header": [
          { "key": "X-API-Key", "value": "{{api_key}}" }
        ]
      }
    },
    {
      "name": "Gallery — Get Card (Not Found)",
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Returns 404', () => pm.response.to.have.status(404));"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "url": {
          "raw": "{{base_url}}/api/gallery/00000000-0000-0000-0000-000000000000",
          "host": ["{{base_url}}"],
          "path": ["api", "gallery", "00000000-0000-0000-0000-000000000000"]
        },
        "header": [
          { "key": "X-API-Key", "value": "{{api_key}}" }
        ]
      }
    },
    {
      "name": "Gallery — Generate Image",
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "const res = pm.response.json();",
              "pm.test('Returns 200', () => pm.response.to.have.status(200));",
              "pm.test('Has card_id', () => pm.expect(res.card_id).to.be.a('string'));",
              "pm.test('Has image_url', () => pm.expect(res.image_url).to.be.a('string'));",
              "pm.test('Has is_truncated', () => pm.expect(res.is_truncated).to.be.a('boolean'));"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "url": {
          "raw": "{{base_url}}/api/gallery/{{card_id}}/image",
          "host": ["{{base_url}}"],
          "path": ["api", "gallery", "{{card_id}}", "image"]
        },
        "header": [
          { "key": "X-API-Key", "value": "{{api_key}}" }
        ]
      }
    },
    {
      "name": "Gallery — Delete Card",
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "const res = pm.response.json();",
              "pm.test('Returns 200', () => pm.response.to.have.status(200));",
              "pm.test('Deleted is true', () => pm.expect(res.deleted).to.eql(true));",
              "pm.test('Has card_id', () => pm.expect(res.card_id).to.be.a('string'));"
            ]
          }
        }
      ],
      "request": {
        "method": "DELETE",
        "url": {
          "raw": "{{base_url}}/api/gallery/{{card_id}}",
          "host": ["{{base_url}}"],
          "path": ["api", "gallery", "{{card_id}}"]
        },
        "header": [
          { "key": "X-API-Key", "value": "{{api_key}}" }
        ]
      }
    },
    {
      "name": "Gallery — No API Key (401)",
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Returns 401', () => pm.response.to.have.status(401));"
            ]
          }
        }
      ],
      "request": {
        "method": "GET",
        "url": {
          "raw": "{{base_url}}/api/gallery",
          "host": ["{{base_url}}"],
          "path": ["api", "gallery"]
        }
      }
    },
    {
      "name": "Swaps — Basic (butter)",
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "const res = pm.response.json();",
              "pm.test('Returns 200', () => pm.response.to.have.status(200));",
              "pm.test('Has original_ingredient', () => pm.expect(res.original_ingredient).to.eql('butter'));",
              "pm.test('Has suggestions array', () => pm.expect(res.suggestions).to.be.an('array'));",
              "pm.test('Has at least one suggestion', () => pm.expect(res.suggestions.length).to.be.at.least(1));",
              "if (res.suggestions.length > 0) {",
              "  const s = res.suggestions[0];",
              "  pm.test('Suggestion has substitute_name', () => pm.expect(s.substitute_name).to.be.a('string'));",
              "  pm.test('Suggestion has quantity_ratio', () => pm.expect(s.quantity_ratio).to.be.a('number'));",
              "  pm.test('Suggestion has confidence', () => pm.expect(s.confidence).to.be.a('number'));",
              "  pm.test('Suggestion has dietary_tags', () => pm.expect(s.dietary_tags).to.be.an('array'));",
              "  pm.test('Confidence is between 0 and 1', () => pm.expect(s.confidence).to.be.within(0, 1));",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "url": {
          "raw": "{{base_url}}/api/swaps",
          "host": ["{{base_url}}"],
          "path": ["api", "swaps"]
        },
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "X-API-Key", "value": "{{api_key}}" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"ingredient\": \"butter\"\n}"
        }
      }
    },
    {
      "name": "Swaps — With Dietary Filter (vegan)",
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "const res = pm.response.json();",
              "pm.test('Returns 200', () => pm.response.to.have.status(200));",
              "pm.test('Has suggestions', () => pm.expect(res.suggestions).to.be.an('array'));",
              "pm.test('Has at least one suggestion', () => pm.expect(res.suggestions.length).to.be.at.least(1));",
              "if (res.suggestions.length > 0) {",
              "  pm.test('First suggestion has dietary tags', () => pm.expect(res.suggestions[0].dietary_tags).to.be.an('array'));",
              "}"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "url": {
          "raw": "{{base_url}}/api/swaps",
          "host": ["{{base_url}}"],
          "path": ["api", "swaps"]
        },
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "X-API-Key", "value": "{{api_key}}" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"ingredient\": \"butter\",\n  \"dietary_filters\": [\"vegan\"]\n}"
        }
      }
    },
    {
      "name": "Swaps — With Available Ingredients",
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "const res = pm.response.json();",
              "pm.test('Returns 200', () => pm.response.to.have.status(200));",
              "pm.test('Has suggestions', () => pm.expect(res.suggestions).to.be.an('array'));",
              "pm.test('Has at least one suggestion', () => pm.expect(res.suggestions.length).to.be.at.least(1));"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "url": {
          "raw": "{{base_url}}/api/swaps",
          "host": ["{{base_url}}"],
          "path": ["api", "swaps"]
        },
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "X-API-Key", "value": "{{api_key}}" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"ingredient\": \"butter\",\n  \"available_ingredients\": [\"coconut oil\", \"olive oil\"]\n}"
        }
      }
    },
    {
      "name": "Swaps — Full Request (heavy cream for carbonara)",
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "const res = pm.response.json();",
              "pm.test('Returns 200', () => pm.response.to.have.status(200));",
              "pm.test('Has original_ingredient', () => pm.expect(res.original_ingredient).to.eql('heavy cream'));",
              "pm.test('Has suggestions', () => pm.expect(res.suggestions).to.be.an('array'));",
              "pm.test('Has 1-5 suggestions', () => {",
              "  pm.expect(res.suggestions.length).to.be.at.least(1);",
              "  pm.expect(res.suggestions.length).to.be.at.most(5);",
              "});",
              "pm.test('Suggestions sorted by confidence desc', () => {",
              "  for (let i = 1; i < res.suggestions.length; i++) {",
              "    pm.expect(res.suggestions[i-1].confidence).to.be.at.least(res.suggestions[i].confidence);",
              "  }",
              "});"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "url": {
          "raw": "{{base_url}}/api/swaps",
          "host": ["{{base_url}}"],
          "path": ["api", "swaps"]
        },
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "X-API-Key", "value": "{{api_key}}" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"ingredient\": \"heavy cream\",\n  \"quantity\": 1,\n  \"unit\": \"cup\",\n  \"recipe_context\": \"pasta carbonara\",\n  \"dietary_filters\": [\"dairy-free\"],\n  \"available_ingredients\": [\"coconut milk\", \"cashews\", \"oat milk\"]\n}"
        }
      }
    },
    {
      "name": "Swaps — Missing Ingredient (400)",
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Returns 400', () => pm.response.to.have.status(400));",
              "pm.test('Has error message', () => pm.expect(pm.response.json().error).to.be.a('string'));"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "url": {
          "raw": "{{base_url}}/api/swaps",
          "host": ["{{base_url}}"],
          "path": ["api", "swaps"]
        },
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "X-API-Key", "value": "{{api_key}}" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{}"
        }
      }
    },
    {
      "name": "Swaps — Invalid dietary_filters (400)",
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Returns 400', () => pm.response.to.have.status(400));",
              "pm.test('Has error about dietary_filters', () => pm.expect(pm.response.json().error).to.include('dietary_filters'));"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "url": {
          "raw": "{{base_url}}/api/swaps",
          "host": ["{{base_url}}"],
          "path": ["api", "swaps"]
        },
        "header": [
          { "key": "Content-Type", "value": "application/json" },
          { "key": "X-API-Key", "value": "{{api_key}}" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"ingredient\": \"butter\",\n  \"dietary_filters\": \"vegan\"\n}"
        }
      }
    },
    {
      "name": "Swaps — No API Key (401)",
      "event": [
        {
          "listen": "test",
          "script": {
            "type": "text/javascript",
            "exec": [
              "pm.test('Returns 401', () => pm.response.to.have.status(401));",
              "pm.test('Has error message', () => pm.expect(pm.response.json().error).to.be.a('string'));"
            ]
          }
        }
      ],
      "request": {
        "method": "POST",
        "url": {
          "raw": "{{base_url}}/api/swaps",
          "host": ["{{base_url}}"],
          "path": ["api", "swaps"]
        },
        "header": [
          { "key": "Content-Type", "value": "application/json" }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"ingredient\": \"butter\"\n}"
        }
      }
    }
  ]
}
